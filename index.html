<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Marketing Net - Sistema de Bodega</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --primary-color: #0d6efd; --secondary-color: #6c757d; }
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .nexus-brand { font-weight: bold; color: var(--primary-color); }
        .section-card { display: none; animation: fadeIn 0.5s; }
        .section-card.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .currency-badge { font-size: 0.9em; font-weight: bold; }
        .stock-warning { color: red; font-weight: bold; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand nexus-brand" href="#">
                <i class="bi bi-box-seam"></i> Nexus Marketing Net
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link active" href="#" onclick="showSection('pos')"><i class="bi bi-cart"></i> Ventas</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('inventory')"><i class="bi bi-boxes"></i> Almacén/Inventario</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('credits')"><i class="bi bi-people"></i> Fiados</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('admin')"><i class="bi bi-file-earmark-spreadsheet"></i> Cierre y Reportes</a></li>
                </ul>
                <span class="text-white me-3" id="tasa-display">Cargando Tasa...</span>
                <span class="text-white small">Soporte: 0424-4525765</span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        
        <div id="pos" class="section-card active">
            <div class="row">
                <div class="col-md-8">
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white">Catálogo de Productos</div>
                        <div class="card-body">
                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" id="searchProduct" class="form-control" placeholder="Buscar producto..." onkeyup="renderCatalog()">
                            </div>
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-hover">
                                    <thead><tr><th>Producto</th><th>Stock</th><th>Precio $</th><th>Precio Bs</th><th>Acción</th></tr></thead>
                                    <tbody id="catalog-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow">
                        <div class="card-header bg-success text-white">Carrito de Compra</div>
                        <div class="card-body">
                            <ul id="cart-list" class="list-group mb-3"></ul>
                            <h4 class="d-flex justify-content-between"><span>Total:</span> <span id="cart-total">$0.00</span></h4>
                            <h5 class="text-end text-muted" id="cart-total-bs">Bs 0.00</h5>
                            <hr>
                            <form id="sale-form">
                                <input type="text" class="form-control mb-2" id="clientName" placeholder="Cliente (Opcional)">
                                <input type="text" class="form-control mb-2" id="clientPhone" placeholder="Teléfono (Opcional)">
                                <select class="form-select mb-3" id="paymentMethod" required onchange="toggleCreditWarning()">
                                    <option value="Efectivo">Efectivo</option>
                                    <option value="Pago Movil">Pago Móvil</option>
                                    <option value="Divisas USD">Divisas USD</option>
                                    <option value="Biopago">Biopago</option>
                                    <option value="Transferencia">Transferencia</option>
                                    <option value="Fiado">Fiado (Crédito)</option>
                                </select>
                                <button type="button" class="btn btn-success w-100" onclick="processSale()">Procesar Venta</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="inventory" class="section-card">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-secondary text-white">Gestión de Stock (Ingreso/Egreso)</div>
                <div class="card-body">
                    <form id="inventory-form" class="row g-3">
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="inv-product" placeholder="Nombre Producto" required>
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control" id="inv-price" placeholder="Precio Unit. ($)" step="0.01" required>
                        </div>
                        <div class="col-md-2">
                            <input type="text" class="form-control" id="inv-char" placeholder="Características">
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control" id="inv-qty" placeholder="Cantidad" required>
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="inv-resp" placeholder="Responsable" required>
                        </div>
                        <div class="col-md-12 text-end">
                             <button type="button" class="btn btn-danger" onclick="updateStock('egreso')"><i class="bi bi-dash-circle"></i> Egreso/Pérdida</button>
                             <button type="button" class="btn btn-primary" onclick="updateStock('ingreso')"><i class="bi bi-plus-circle"></i> Ingreso/Compra</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <h5 class="mt-4">Historial de Movimientos (Ingresos y Egresos)</h5>
            <div class="table-responsive">
                <table class="table table-bordered table-striped" id="movements-table">
                    <thead class="table-dark">
                        <tr>
                            <th>Hora</th>
                            <th>Responsable</th>
                            <th>Tipo</th>
                            <th>Cant.</th>
                            <th>Producto</th>
                            <th>Características</th>
                        </tr>
                    </thead>
                    <tbody id="movements-body"></tbody>
                </table>
            </div>
        </div>

        <div id="credits" class="section-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Control de Cuentas por Cobrar (Fiado)</h3>
                <button class="btn btn-success" onclick="exportTableToExcel('credits-table', 'Control_Fiados')"><i class="bi bi-file-excel"></i> Exportar Excel</button>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="credits-table">
                    <thead class="table-warning">
                        <tr>
                            <th>Deudor</th>
                            <th>Teléfono</th>
                            <th>Producto</th>
                            <th>Valor ($)</th>
                            <th>Valor (Bs) Hoy</th>
                            <th>Estado</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="credits-body"></tbody>
                </table>
            </div>
        </div>

        <div id="admin" class="section-card">
            <div class="row">
                <div class="col-md-6">
                    <div class="card text-center mb-4 border-danger">
                        <div class="card-header bg-danger text-white">CIERRE DE CAJA</div>
                        <div class="card-body">
                            <p>Esta acción borrará las ventas del día para iniciar un nuevo turno.</p>
                            <input type="text" id="close-resp" class="form-control mb-3" placeholder="Nombre Responsable (Obligatorio)">
                            <button class="btn btn-danger w-100" onclick="closeRegister()">REALIZAR CIERRE</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header">Exportar Datos</div>
                        <div class="card-body d-grid gap-2">
                            <button class="btn btn-primary" onclick="exportSales()"><i class="bi bi-cart-check"></i> Exportar Ventas del Día</button>
                            <button class="btn btn-secondary" onclick="exportInventory()"><i class="bi bi-box-seam"></i> Exportar Stock Actual</button>
                        </div>
                    </div>
                </div>
            </div>

            <h5>Ventas del Día (Actual)</h5>
            <div class="table-responsive">
                <table class="table table-sm" id="sales-table">
                    <thead>
                        <tr><th>Hora</th><th>Vendedor</th><th>Productos</th><th>Cliente</th><th>Pago</th><th>Total $</th></tr>
                    </thead>
                    <tbody id="sales-body"></tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // --- ESTADO INICIAL ---
        let products = JSON.parse(localStorage.getItem('nexus_products')) || [];
        let movements = JSON.parse(localStorage.getItem('nexus_movements')) || [];
        let sales = JSON.parse(localStorage.getItem('nexus_sales')) || [];
        let credits = JSON.parse(localStorage.getItem('nexus_credits')) || [];
        let cart = [];
        let dollarRate = 0;

        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchDollarRate();
            renderCatalog();
            renderMovements();
            renderCredits();
            renderSalesTable();
            // Actualizar tasa cada 10 minutos
            setInterval(fetchDollarRate, 600000);
        });

        // --- API DOLAR ---
        async function fetchDollarRate() {
            try {
                const response = await fetch('https://ve.dolarapi.com/v1/dolares/promedio'); // Usamos promedio o oficial
                const data = await response.json();
                dollarRate = data.promedio;
                document.getElementById('tasa-display').innerText = `Tasa: Bs ${dollarRate.toFixed(2)}`;
                renderCatalog(); // Re-renderizar precios
                renderCredits(); // Re-renderizar deudas en Bs
            } catch (error) {
                console.error("Error API Dolar", error);
                document.getElementById('tasa-display').innerText = "Tasa: Error API";
                dollarRate = 50; // Fallback manual si falla
            }
        }

        // --- NAVEGACIÓN ---
        function showSection(id) {
            document.querySelectorAll('.section-card').forEach(sec => sec.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            event.target.closest('.nav-link').classList.add('active');
        }

        // --- ALMACÉN / INVENTARIO ---
        function updateStock(type) {
            const name = document.getElementById('inv-product').value;
            const price = parseFloat(document.getElementById('inv-price').value) || 0;
            const char = document.getElementById('inv-char').value;
            const qty = parseInt(document.getElementById('inv-qty').value);
            const resp = document.getElementById('inv-resp').value;

            if(!name || !qty || !resp) return Swal.fire('Error', 'Complete campos obligatorios', 'error');

            // Actualizar lista de productos
            let prod = products.find(p => p.name.toLowerCase() === name.toLowerCase());
            
            if (type === 'ingreso') {
                if(prod) {
                    prod.stock += qty;
                    prod.price = price > 0 ? price : prod.price; // Actualizar precio si se provee
                } else {
                    prod = { name, price, char, stock: qty };
                    products.push(prod);
                }
            } else {
                if(!prod || prod.stock < qty) return Swal.fire('Error', 'Stock insuficiente', 'error');
                prod.stock -= qty;
            }

            // Registrar Movimiento
            movements.push({
                date: new Date().toLocaleString(),
                responsible: resp,
                type: type.toUpperCase(),
                qty,
                product: name,
                char
            });

            saveData();
            document.getElementById('inventory-form').reset();
            Swal.fire('Éxito', `Inventario actualizado: ${type}`, 'success');
            renderCatalog();
            renderMovements();
        }

        function renderMovements() {
            const tbody = document.getElementById('movements-body');
            tbody.innerHTML = movements.map(m => `
                <tr>
                    <td>${m.date}</td>
                    <td>${m.responsible}</td>
                    <td class="${m.type === 'INGRESO' ? 'text-success' : 'text-danger'}">${m.type}</td>
                    <td>${m.qty}</td>
                    <td>${m.product}</td>
                    <td>${m.char || '-'}</td>
                </tr>
            `).reverse().join('');
        }

        // --- VENTAS (POS) ---
        function renderCatalog() {
            const search = document.getElementById('searchProduct').value.toLowerCase();
            const tbody = document.getElementById('catalog-body');
            tbody.innerHTML = products
                .filter(p => p.name.toLowerCase().includes(search))
                .map(p => `
                <tr>
                    <td>${p.name} <small class="text-muted">${p.char || ''}</small></td>
                    <td class="${p.stock < 5 ? 'stock-warning' : ''}">${p.stock}</td>
                    <td>$${p.price.toFixed(2)}</td>
                    <td>Bs ${(p.price * dollarRate).toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="addToCart('${p.name}')" ${p.stock <= 0 ? 'disabled' : ''}>
                            <i class="bi bi-plus"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function addToCart(prodName) {
            const prod = products.find(p => p.name === prodName);
            const itemInCart = cart.find(i => i.name === prodName);

            if (prod.stock <= 0) return;

            if (itemInCart) {
                if (itemInCart.qty < prod.stock) itemInCart.qty++;
            } else {
                cart.push({ ...prod, qty: 1 });
            }
            renderCart();
        }

        function renderCart() {
            const list = document.getElementById('cart-list');
            let total = 0;
            list.innerHTML = cart.map((item, index) => {
                total += item.price * item.qty;
                return `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <b>${item.name}</b> x${item.qty}
                    </div>
                    <span>$${(item.price * item.qty).toFixed(2)} 
                        <i class="bi bi-trash text-danger ms-2" style="cursor:pointer" onclick="removeFromCart(${index})"></i>
                    </span>
                </li>`;
            }).join('');
            
            document.getElementById('cart-total').innerText = `$${total.toFixed(2)}`;
            document.getElementById('cart-total-bs').innerText = `Bs ${(total * dollarRate).toFixed(2)}`;
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            renderCart();
        }

        function processSale() {
            if (cart.length === 0) return Swal.fire('Carrito vacío', 'Agregue productos', 'warning');

            const method = document.getElementById('paymentMethod').value;
            const client = document.getElementById('clientName').value;
            const phone = document.getElementById('clientPhone').value;
            
            // Validación para Fiado
            if (method === 'Fiado' && (!client || !phone)) {
                return Swal.fire('Atención', 'Para fiar es obligatorio Nombre y Teléfono', 'warning');
            }

            // Descontar Stock
            cart.forEach(item => {
                const prod = products.find(p => p.name === item.name);
                if(prod) prod.stock -= item.qty;
            });

            const totalUSD = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);

            // Registrar Venta
            const sale = {
                date: new Date().toLocaleString(),
                seller: 'Cajero Turno', // Idealmente vendría de un login
                items: cart.map(i => `${i.name} (${i.qty})`).join(', '),
                client: client || 'Anónimo',
                phone: phone || '-',
                method: method,
                total: totalUSD
            };
            sales.push(sale);

            // Si es Fiado, agregar a Créditos
            if (method === 'Fiado') {
                cart.forEach(item => {
                    credits.push({
                        debtor: client,
                        phone: phone,
                        product: item.name,
                        qty: item.qty,
                        valUSD: (item.price * item.qty),
                        date: new Date().toLocaleDateString(),
                        paid: false
                    });
                });
                renderCredits();
            }

            // Limpiar y Guardar
            cart = [];
            document.getElementById('sale-form').reset();
            renderCart();
            renderCatalog();
            renderSalesTable();
            saveData();

            Swal.fire('Venta Exitosa', `Total: $${totalUSD.toFixed(2)}`, 'success');
        }

        // --- FIADOS ---
        function renderCredits() {
            const tbody = document.getElementById('credits-body');
            tbody.innerHTML = credits.map((c, i) => `
                <tr class="${c.paid ? 'table-success' : ''}">
                    <td>${c.debtor}</td>
                    <td>${c.phone}</td>
                    <td>${c.product} (x${c.qty || 1})</td>
                    <td>$${c.valUSD.toFixed(2)}</td>
                    <td>Bs ${(c.valUSD * dollarRate).toFixed(2)}</td>
                    <td>${c.paid ? 'PAGADO' : 'PENDIENTE'}</td>
                    <td>
                        ${!c.paid ? `<button class="btn btn-sm btn-success" onclick="markPaid(${i})">Pagar</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function markPaid(index) {
            credits[index].paid = true;
            credits[index].paidDate = new Date().toLocaleString();
            saveData();
            renderCredits();
        }

        // --- CIERRE Y EXPORTACIÓN ---
        function renderSalesTable() {
            document.getElementById('sales-body').innerHTML = sales.map(s => `
                <tr>
                    <td>${s.date}</td>
                    <td>${s.seller}</td>
                    <td>${s.items}</td>
                    <td>${s.client}</td>
                    <td>${s.method}</td>
                    <td>$${s.total.toFixed(2)}</td>
                </tr>
            `).join('');
        }

        function exportSales() {
            if(sales.length === 0) return Swal.fire('Info', 'No hay ventas hoy', 'info');
            const ws = XLSX.utils.json_to_sheet(sales);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Ventas");
            XLSX.writeFile(wb, `Ventas_${new Date().toLocaleDateString().replace(/\//g,'-')}.xlsx`);
        }

        function exportInventory() {
            const ws = XLSX.utils.json_to_sheet(products);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Inventario");
            XLSX.writeFile(wb, `Stock_${new Date().toLocaleDateString().replace(/\//g,'-')}.xlsx`);
        }
        
        function exportTableToExcel(tableId, filename) {
            let table = document.getElementById(tableId);
            let wb = XLSX.utils.table_to_book(table);
            XLSX.writeFile(wb, filename + ".xlsx");
        }

        function closeRegister() {
            const resp = document.getElementById('close-resp').value;
            if (!resp) return Swal.fire('Error', 'Ingrese el nombre del responsable', 'error');

            Swal.fire({
                title: '¿Cerrar Caja?',
                text: "Se exportarán las ventas y se reiniciará el contador diario.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, cerrar'
            }).then((result) => {
                if (result.isConfirmed) {
                    exportSales(); // Auto exportar
                    sales = []; // Reset ventas
                    document.getElementById('close-resp').value = '';
                    saveData();
                    renderSalesTable();
                    Swal.fire('Caja Cerrada', `Responsable: ${resp}`, 'success');
                }
            });
        }

        // --- PERSISTENCIA ---
        function saveData() {
            localStorage.setItem('nexus_products', JSON.stringify(products));
            localStorage.setItem('nexus_movements', JSON.stringify(movements));
            localStorage.setItem('nexus_sales', JSON.stringify(sales));
            localStorage.setItem('nexus_credits', JSON.stringify(credits));
        }
    </script>
</body>
</html>
